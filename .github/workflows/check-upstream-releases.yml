# .github/workflows/check-upstream-releases.yml
name: Check Upstream Releases

on:
  schedule:
    # Run daily at 9 AM UTC
    - cron: "0 6 1,15 * *"
  workflow_dispatch: # Allow manual triggering

permissions:
  issues: write
  contents: write
  pull-requests: write

jobs:
  check-upstream:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Fetch latest upstream tag
        id: upstream
        run: |
          LATEST_TAG=$(curl -s https://api.github.com/repos/flexprice/flexprice-front/tags | jq -r '.[0].name')
          echo "latest_version=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Latest upstream tag: $LATEST_TAG"

      - name: Compare versions
        id: compare
        env:
          TRACKED_VERSION: ${{ secrets.LATEST_TRACKED_VERSION }}
          LATEST_VERSION: ${{ steps.upstream.outputs.latest_version }}
        run: |
          echo "Tracked version: $TRACKED_VERSION"
          echo "Latest version: $LATEST_VERSION"

          if [ "$LATEST_VERSION" != "$TRACKED_VERSION" ]; then
            echo "new_version_available=true" >> $GITHUB_OUTPUT
            echo "⚠️ New version available: $LATEST_VERSION (currently tracking: $TRACKED_VERSION)"
          else
            echo "new_version_available=false" >> $GITHUB_OUTPUT
            echo "✅ Already tracking the latest version: $TRACKED_VERSION"
          fi

      - name: Pull new tag from upstream
        if: steps.compare.outputs.new_version_available == 'true'
        env:
          LATEST_VERSION: ${{ steps.upstream.outputs.latest_version }}
          TRACKED_VERSION: ${{ secrets.LATEST_TRACKED_VERSION }}
          GH_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
        run: |
          echo "Setting up git configuration..."
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          echo "Setting up upstream remote..."
          git remote add upstream https://github.com/flexprice/flexprice-front.git || git remote set-url upstream https://github.com/flexprice/flexprice-front.git

          echo "Fetching from upstream..."
          git fetch upstream --tags

          echo "Creating branch for new version..."
          BRANCH_NAME="update-to-$LATEST_VERSION"

          # Delete existing local branch if it exists
          git branch -D $BRANCH_NAME 2>/dev/null || true

          git checkout -b $BRANCH_NAME

          echo "Merging tag $LATEST_VERSION from upstream..."
          git merge --no-edit tags/$LATEST_VERSION || {
            echo "Merge conflict detected. Committing conflict markers for manual resolution."
            git add .
            git commit -m "Merge upstream tag $LATEST_VERSION (with conflicts)"
          }

          echo "Preserving fork's .github/workflows..."
          # Remove all workflows from the merge (including upstream workflows)
          rm -rf .github/workflows/*

          # Copy only the workflows from our main branch
          git checkout origin/main -- .github/workflows/

          # Check if there are any changes to commit
          if ! git diff --quiet || ! git diff --cached --quiet; then
            git add .github/workflows
            git commit -m "Preserve fork's .github workflows (remove upstream workflows)"
            echo "✅ Preserved fork's .github/workflows directory"
          else
            echo "ℹ️ No changes needed to .github/workflows"
          fi

          echo "Checking if there are any differences with main..."
          git fetch origin main
          COMMIT_DIFF=$(git rev-list --count origin/main..$BRANCH_NAME)

          if [ "$COMMIT_DIFF" -eq "0" ]; then
            echo "⚠️ No new commits to merge. The version $LATEST_VERSION is already in main."
            echo "Skipping PR creation."
            exit 0
          fi

          echo "Found $COMMIT_DIFF new commit(s). Proceeding with PR creation..."

          echo "Pushing branch to origin (force push to overwrite if exists)..."
          git push -u origin $BRANCH_NAME --force

          # Get the repository owner/name (e.g., districtinc/flexprice-front)
          REPO="${GITHUB_REPOSITORY}"

          echo "Checking if PR already exists..."
          EXISTING_PR=$(gh pr list --repo "$REPO" --head "$BRANCH_NAME" --json number --jq '.[0].number' 2>/dev/null || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "PR already exists (#$EXISTING_PR). Updating PR with new commits..."
            gh pr edit $EXISTING_PR \
              --repo "$REPO" \
              --title "Update to upstream version $LATEST_VERSION" \
              --body "## Upstream Update Available

          This PR updates the codebase to track the new upstream tag: \`$LATEST_VERSION\`

          **Previous version:** \`$TRACKED_VERSION\`
          **New version:** \`$LATEST_VERSION\`

          ### Changes
          - View upstream release: https://github.com/flexprice/flexprice-front/releases/tag/$LATEST_VERSION
          - Compare changes: https://github.com/flexprice/flexprice-front/compare/$TRACKED_VERSION...$LATEST_VERSION

          ### Next Steps
          1. Review the upstream changes
          2. Test the changes
          3. Merge this PR if everything looks good

          **Note:** The \`LATEST_TRACKED_VERSION\` secret will be automatically updated after the Docker image is built successfully."

            echo "✅ Successfully updated existing PR #$EXISTING_PR for $LATEST_VERSION"
          else
            echo "Creating new pull request in fork repository..."
            echo "DEBUG: REPO variable = $REPO"
            echo "DEBUG: GITHUB_REPOSITORY = $GITHUB_REPOSITORY"
            echo "DEBUG: BRANCH_NAME = $BRANCH_NAME"

            PR_URL=$(gh pr create \
              --repo "$REPO" \
              --base main \
              --head "$BRANCH_NAME" \
              --title "Update to upstream version $LATEST_VERSION" \
              --body "## Upstream Update Available

            This PR updates the codebase to track the new upstream tag: \`$LATEST_VERSION\`

            **Previous version:** \`$TRACKED_VERSION\`
            **New version:** \`$LATEST_VERSION\`

            ### Changes
            - View upstream release: https://github.com/flexprice/flexprice-front/releases/tag/$LATEST_VERSION
            - Compare changes: https://github.com/flexprice/flexprice-front/compare/$TRACKED_VERSION...$LATEST_VERSION

            ### Next Steps
            1. Review the upstream changes
            2. Test the changes
            3. Merge this PR if everything looks good

            **Note:** The \`LATEST_TRACKED_VERSION\` secret will be automatically updated after the Docker image is built successfully.")

            echo "✅ Successfully created pull request: $PR_URL"

            # Add labels to the PR
            echo "Adding labels to PR..."
            PR_NUMBER=$(echo $PR_URL | grep -o '[0-9]*$')
            gh pr edit $PR_NUMBER --repo "$REPO" --add-label "upstream-update" --add-label "automated-pr" || echo "Warning: Could not add labels"
          fi

      - name: Summary
        run: |
          if [ "${{ steps.compare.outputs.new_version_available }}" == "true" ]; then
            echo "### ⚠️ New Upstream Tag Available" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Latest:** ${{ steps.upstream.outputs.latest_version }}" >> $GITHUB_STEP_SUMMARY
            echo "**Tracked:** ${{ secrets.LATEST_TRACKED_VERSION }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ Pull request created to merge upstream changes" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ✅ Up to Date" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Currently tracking the latest upstream tag: ${{ secrets.LATEST_TRACKED_VERSION }}" >> $GITHUB_STEP_SUMMARY
          fi
